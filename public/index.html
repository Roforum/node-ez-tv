<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Node EZ TV</title>
    <meta name="viewport" content="width=device-width, initial-scale=.75, user-scalable=no">
  </head>
  <body>
    <style type="text/css">
      html,body{
        text-align:center;
        margin:0;
        padding:0;
        width:100%;
        height:100%;
        background-color:#EEE;
      }
      *{
        text-align:start;
        font-family:Verdana,Arial,sans-serif;
        shape-rendering: crispEdges;
        line-height:1.5em;
        font-weight:lighter;
      }
      h1,h2,h3,h4,h5,h6,h7,.timeline-label{
          font-family: "Helvetica Nueue","Roboto",Helvetica,Arial,sans-serif;
          background-color: #FF7300;
          color: white;
          padding: 0 1em;
      }
      .axis path,
      .axis line {
        fill: none;   
        stroke: black;
      }

      .axis text {
        font-size: 18px;
      }

      .timeline-label {
        font-size: 16px;
        text-align:right;
        width:100%;
        cursor:pointer;
        display:block;
        fill-color:yellow;
      }

      svg.scrollable {
        cursor:ew-resize;
      }

      .coloredDiv {
        height: 20px;
        width: 20px;
        float: left;
      }
      .betterlabel{
        height:200px;
        width:100px;  
      }
      #timeline{
        background-color:white;
        
        border: solid 1px rgba(0, 0, 0, 0.23);
        box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.1);
      }
      #timeline svg{
        width:100%;
      }
      #desc{
        margin: 1em;
        display: inline-block;
        max-width: 600px;
        background-color: white;
        border: solid 1px rgba(0, 0, 0, 0.23);
        box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.1);
      }
      #desc h1{
        margin:0;
      }
      #desc p{
        margin:1em;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/jiahuang/d3-timeline/master/src/d3-timeline.js"></script>   
   
   <div id="timeline"></div>
    <div id="desc"></div>

    <script>
$.get('/guide.json',updateTimeline);
//window.setInterval(function(){$.get('/guide.json',updateTimeline);},10000);

function updateTimeline(guideData){

  //window.guideData = guideData;

  var shows = {};
  var chartData = [];
  for(var i = 0; i < guideData.length; i ++){
    if(!shows[guideData[i].name]){
      shows[guideData[i].name] = {label:guideData[i].name,times:[]};
    }
    var start = new Date(guideData[i].date).getTime()
    var end = new Date(guideData[i].endDate).getTime()
    var hr = (((new Date(start).getHours() +11) % 12)+1);
    var mn = ('0'+(new Date(start).getMinutes()) ).slice(-2);
    var label = hr+':'+mn;
    shows[guideData[i].name].times.push({
      starting_time:start,
      ending_time:end,
      label:label,
      class:'show-label'
    });
    
  }

  var showNames = Object.keys(shows);
  for(var i = 0; i < showNames.length; i++){
    chartData.push(shows[showNames[i]]);
  }
  //console.log(chartData);
  var chart = d3.timeline()
  .margin({left:110, right:30, top:10, bottom:0})
  .width(10000)
  .stack()
  .showTimeAxisTick()
  .beginning(new Date())

  var tl = d3.select("#timeline");
  var svg = tl.append("svg").attr("width", 1000);

  svg.datum(chartData).call(chart);

  var textWidth =0;
  var svgHeight = 100;
  svg.selectAll("text.timeline-label")
  .each(function () {
    this.setAttribute('data-name',this.innerHTML);
    this.innerHTML = trimTo(this.innerHTML,25);
    textWidth = Math.min(Math.max( this.getComputedTextLength(),textWidth ),200);
    this.setAttribute('textLength',Math.min(this.getComputedTextLength(),200))
  });

  svg.each(function(){
    svgHeight = Number(this.getAttribute('height'));
  });

  var coverRect = svg
    .insert("rect",'.timeline-label')
    .attr("x", 0)
    .attr("y", 0)
    .attr("width", textWidth+5)
    .attr("height", svgHeight)
    .style("fill", "rgba(255,255,255,.9)")

  var eatRect =  svg
    .insert('rect','.timeline-label')
    .attr('x',textWidth+4)
    .attr('y','0')
    .attr('height','100%')
    .attr('width','1')
    .attr('fill','black')
   
  window.showNameMap = {};
  guideData.forEach(function(el){
    if(showNameMap[el.name]) return;
    showNameMap[el.name]=el;
  });
   
  d3.selectAll('.timeline-label')
    .on('click',function(){
      console.log('got click',this);
      updateShowPanel($(this).attr('data-name') || this.innerHTML);
    });
    
  updateShowPanel($('.timeline-label').first().attr('data-name'));

}

function updateShowPanel(showName){
  var plussed = showName.replace(/\s/ig,'+');
  
  var omdbUrl = 'https://www.omdbapi.com/?t='+plussed+'&plot=full&r=json';
  if (window.showNameMap && window.showNameMap[showName] && window.showNameMap[showName].mediaType === 'show' || window,showNameMap[showName].mediaType === 'series'){
    omdbUrl+='&type=series';
  }else if (window.showNameMap && window.showNameMap[showName] && window.showNameMap[showName].mediaType === 'movie' || window,showNameMap[showName].mediaType === 'film'){
    omdbUrl+='&type=movie';
  }
  
  
  
  $.get(omdbUrl,function(data){
  
    
    var header = $('<h1></h1>');
    header.text(data.Title);
    
    var plot = $('<p></p>');
    plot.text(data.Plot);
    
    var desc = $('#desc');
    desc.html('');
    desc.append(header);
    desc.append(plot);
    
  });

};


function trimTo(str,maxLength,replaceWith){
  if (str.length <= maxLength){
    return str;
  }
  var ellipsis = replaceWith || 'â€¦';
  return str.substr(0,maxLength - (ellipsis.length) ) + ellipsis;
}


    </script>
  </body>
</html>